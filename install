#!/bin/bash

#############
# FUNCTIONS #
#############

function apt_installation()
{
    sudo apt update
    sudo apt upgrade -y
    sudo apt install -y $(cat ./lists/apt.list)
}

function pacman_installation()
{
    sudo pacman -Syyu
    sudo pacman -Sy --needed $(cat ./lists/pacman.list)
    # teams
    git clone https://aur.archlinux.org/teams.git
    cd teams
    makepkg -si
    cd ..
    rm -rf teams/
}

function zypper_installation()
{
    sudo zypper ref
    sudo zypper update
    sudo zypper install -y $(cat ./lists/zypper.list)
}

function emerge_installation()
{
    sudo emerge -avDuN world
    sudo emerge -avy $(cat ./lists/emerge.list)
}

function flatpak_installation()
{
    sudo flatpak update
    sudo flatpak remote-add --if-not-exists flathub https://flathub.org/repo/flathub.flatpakrepo
    sudo flatpak install $(cat ./lists/flatpak.list)
}

function installation_manager() {
    echo "package manager found: $1!"
    if [[ $1 = "apt" ]]; then
        apt_installation
    elif [[ $1 = "dnf" ]]; then
        echo "Head over to https://github.com/Epitech/dump to install the dump."
    elif [[ $1 = "pacman" ]]; then
        archlinux_installation
    elif [[ $1 = "zypper" ]]; then
        opensuse_installation
    elif [[ $1 = "emerge" ]]; then
        gentoo_installation
    elif [[ $1 = "flatpak" ]]; then
        flatpak_installation
    fi
}

########
# CODE #
########

# Get package manager name
package_managers=("apt" "dnf" "pacman" "zypper" "emerge")
has_found=0
package_manager_found=""
for element in "${package_managers[@]}"; do
    which "$element" &> /dev/null
    if [[ $? -eq 0 ]]; then
        has_found=1
        package_manager_found=$element
    fi
done

# .
if [[ has_found -eq 1 ]]; then
    installation_manager $package_manager_found
else
    echo "I couldn't find any known package manager..."
    which "flatpak" &> /dev/null
    if [[ $? -eq 0 ]]; then
        echo "A flatpak setup has been found... lucky you there's an available flatpak installation for the epitech dump!"
        installation_manager "flatpak"
    else
        echo "No flatpak installation couldn't be found.. Go check if your distro is eligible for flatpak: https://flatpak.org/setup/"
        printf "2 cases:\n%s\n%s\n" "- If you can see your distro in the list: congrats, you're saved! Go setup flatpak (on the same link) and come back to install the packages." "- If you can't see your distro in the list, I'm sorry because you won't be able to install the epitech dump on your current system... unless you install every package from source."
    fi
fi
